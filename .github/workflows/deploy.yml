name: Build & Deploy Hexo Blog

on:
  push:
    branches: ["master"]
  workflow_dispatch:

env:
  SSH_HOST: ${{ secrets.SSH_HOST }}
  SSH_USER: ${{ secrets.SSH_USER }}
  SSH_PORT: ${{ secrets.SSH_PORT }}
  TARGET_DIR: ${{ secrets.TARGET_DIR }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 0

      # æ£€æµ‹åŒ…ç®¡ç†å™¨
      - name: Detect package manager
        id: pm
        run: |
          cd anzhiyu-blog
          if [ -f pnpm-lock.yaml ]; then
            echo "pm=pnpm" >> $GITHUB_OUTPUT
            echo "cache-path=anzhiyu-blog/pnpm-lock.yaml" >> $GITHUB_OUTPUT
          elif [ -f yarn.lock ]; then
            echo "pm=yarn" >> $GITHUB_OUTPUT
            echo "cache-path=anzhiyu-blog/yarn.lock" >> $GITHUB_OUTPUT
          elif [ -f package-lock.json ]; then
            echo "pm=npm" >> $GITHUB_OUTPUT
            echo "cache-path=anzhiyu-blog/package-lock.json" >> $GITHUB_OUTPUT
          else
            echo "pm=npm" >> $GITHUB_OUTPUT
            echo "cache-path=anzhiyu-blog/package.json" >> $GITHUB_OUTPUT
          fi

      # è®¾ç½® Node.js ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: ${{ steps.pm.outputs.pm }}
          cache-dependency-path: ${{ steps.pm.outputs.cache-path }}

      # å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: |
          set -e
          cd anzhiyu-blog

          echo "ğŸ“¦ Installing dependencies with ${{ steps.pm.outputs.pm }}..."

          if [ "${{ steps.pm.outputs.pm }}" = "pnpm" ]; then
            npm install -g pnpm
            pnpm install --frozen-lockfile
          elif [ "${{ steps.pm.outputs.pm }}" = "yarn" ]; then
            yarn install --frozen-lockfile
          else
            npm ci
          fi

      # æ„å»ºåšå®¢
      - name: Build Hexo blog
        run: |
          set -e
          cd anzhiyu-blog

          echo "ğŸ—ï¸ Building Hexo blog..."

          # æ¸…ç†ç¼“å­˜
          if [ "${{ steps.pm.outputs.pm }}" = "pnpm" ]; then
            pnpm run clean
          elif [ "${{ steps.pm.outputs.pm }}" = "yarn" ]; then
            yarn clean
          else
            npm run clean
          fi

          # æ„å»ºé™æ€æ–‡ä»¶
          if [ "${{ steps.pm.outputs.pm }}" = "pnpm" ]; then
            pnpm run build
          elif [ "${{ steps.pm.outputs.pm }}" = "yarn" ]; then
            yarn build
          else
            npm run build
          fi

      # éªŒè¯æ„å»ºç»“æœ
      - name: Verify build output
        run: |
          cd anzhiyu-blog
          if [ -d "public" ] && [ "$(ls -A public)" ]; then
            echo "âœ… Build successful! Files generated:"
            ls -la public/ | head -10
            echo "OUT_DIR=anzhiyu-blog/public" >> $GITHUB_ENV
          else
            echo "âŒ Build failed: public directory is empty or doesn't exist!"
            exit 1
          fi

      # æ¸…ç†ç›®æ ‡ç›®å½•å¹¶éƒ¨ç½²å®Œæ•´ä»“åº“
      - name: Clean and deploy full repository
        run: |
          # åˆ›å»ºä¸´æ—¶SSHé…ç½®
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # æ¸…ç†ç›®æ ‡ç›®å½•
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "rm -rf ${{ secrets.TARGET_DIR }}/web/* && mkdir -p ${{ secrets.TARGET_DIR }}/web"

          # éƒ¨ç½²å®Œæ•´ä»“åº“
          rsync -avzr --exclude='.git*' --exclude='anzhiyu-blog/node_modules' --exclude='anzhiyu-blog/public' --exclude='*.log' \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -p ${{ secrets.SSH_PORT }}" \
            ./ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.TARGET_DIR }}/

          # éƒ¨ç½²æ„å»ºåçš„ç½‘ç«™æ–‡ä»¶
          rsync -avzr --delete \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -p ${{ secrets.SSH_PORT }}" \
            ${{ env.OUT_DIR }}/ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.TARGET_DIR }}/web/

          # æ¸…ç†SSHå¯†é’¥
          rm ~/.ssh/deploy_key

      # éƒ¨ç½²åéªŒè¯
      - name: Post-deployment verification
        run: |
          echo "ğŸ‰ Deployment completed!"
          echo "ğŸ“ Blog should be accessible at: http://${{ secrets.SSH_HOST }}"
          echo "ğŸ“ Files deployed to: ${{ secrets.TARGET_DIR }}"
