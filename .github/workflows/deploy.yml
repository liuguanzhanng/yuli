name: Build & Deploy Hexo Blog

on:
  push:
    branches: ["main", "master"]
  workflow_dispatch:

env:
  SSH_HOST: ${{ secrets.SSH_HOST }}
  SSH_USER: ${{ secrets.SSH_USER }}
  SSH_PORT: ${{ secrets.SSH_PORT }}
  TARGET_DIR: ${{ secrets.TARGET_DIR }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 0

      # æ£€æµ‹åŒ…ç®¡ç†å™¨
      - name: Detect package manager
        id: pm
        run: |
          cd anzhiyu-blog
          if [ -f pnpm-lock.yaml ]; then
            echo "pm=pnpm" >> $GITHUB_OUTPUT
            echo "cache-path=anzhiyu-blog/pnpm-lock.yaml" >> $GITHUB_OUTPUT
          elif [ -f yarn.lock ]; then
            echo "pm=yarn" >> $GITHUB_OUTPUT
            echo "cache-path=anzhiyu-blog/yarn.lock" >> $GITHUB_OUTPUT
          elif [ -f package-lock.json ]; then
            echo "pm=npm" >> $GITHUB_OUTPUT
            echo "cache-path=anzhiyu-blog/package-lock.json" >> $GITHUB_OUTPUT
          else
            echo "pm=npm" >> $GITHUB_OUTPUT
            echo "cache-path=anzhiyu-blog/package.json" >> $GITHUB_OUTPUT
          fi

      # è®¾ç½® Node.js ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: ${{ steps.pm.outputs.pm }}
          cache-dependency-path: ${{ steps.pm.outputs.cache-path }}

      # å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: |
          set -e
          cd anzhiyu-blog

          echo "ğŸ“¦ Installing dependencies with ${{ steps.pm.outputs.pm }}..."

          if [ "${{ steps.pm.outputs.pm }}" = "pnpm" ]; then
            npm install -g pnpm
            pnpm install --frozen-lockfile
          elif [ "${{ steps.pm.outputs.pm }}" = "yarn" ]; then
            yarn install --frozen-lockfile
          else
            npm ci
          fi

      # æ„å»ºåšå®¢
      - name: Build Hexo blog
        run: |
          set -e
          cd anzhiyu-blog

          echo "ğŸ—ï¸ Building Hexo blog..."

          # æ¸…ç†ç¼“å­˜
          if [ "${{ steps.pm.outputs.pm }}" = "pnpm" ]; then
            pnpm run clean
          elif [ "${{ steps.pm.outputs.pm }}" = "yarn" ]; then
            yarn clean
          else
            npm run clean
          fi

          # æ„å»ºé™æ€æ–‡ä»¶
          if [ "${{ steps.pm.outputs.pm }}" = "pnpm" ]; then
            pnpm run build
          elif [ "${{ steps.pm.outputs.pm }}" = "yarn" ]; then
            yarn build
          else
            npm run build
          fi

      # éªŒè¯æ„å»ºç»“æœ
      - name: Verify build output
        run: |
          cd anzhiyu-blog
          if [ -d "public" ] && [ "$(ls -A public)" ]; then
            echo "âœ… Build successful! Files generated:"
            ls -la public/ | head -10
            echo "OUT_DIR=anzhiyu-blog/public" >> $GITHUB_ENV
          else
            echo "âŒ Build failed: public directory is empty or doesn't exist!"
            exit 1
          fi

      # éƒ¨ç½²å®Œæ•´ä»“åº“åˆ°æœåŠ¡å™¨
      - name: Deploy full repository to server
        uses: burnett01/rsync-deployments@6.0.0
        with:
          switches: -avzr --delete --exclude='.git*' --exclude='anzhiyu-blog/node_modules' --exclude='*.log'
          path: ./
          remote_path: ${{ secrets.TARGET_DIR }}/
          remote_host: ${{ secrets.SSH_HOST }}
          remote_port: ${{ secrets.SSH_PORT }}
          remote_user: ${{ secrets.SSH_USER }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}

      # éƒ¨ç½²æ„å»ºåçš„åšå®¢æ–‡ä»¶åˆ°webç›®å½•
      - name: Deploy built blog to web directory
        uses: burnett01/rsync-deployments@6.0.0
        with:
          switches: -avzr --delete
          path: ${{ env.OUT_DIR }}/
          remote_path: ${{ secrets.TARGET_DIR }}/web/
          remote_host: ${{ secrets.SSH_HOST }}
          remote_port: ${{ secrets.SSH_PORT }}
          remote_user: ${{ secrets.SSH_USER }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}

      # éƒ¨ç½²åéªŒè¯
      - name: Post-deployment verification
        run: |
          echo "ğŸ‰ Deployment completed!"
          echo "ğŸ“ Blog should be accessible at: http://${{ secrets.SSH_HOST }}"
          echo "ğŸ“ Files deployed to: ${{ secrets.TARGET_DIR }}"
