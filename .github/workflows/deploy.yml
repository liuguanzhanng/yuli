name: Sync public to VPS

on:
  push:
    branches: [ master ]
    paths:
      - 'anzhiyu-blog/public/**'   # 只有 public 有变更才触发
  workflow_dispatch: {}            # 支持手动触发

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true                 # 如果 public 里有大文件且使用了 LFS

      - name: Ensure target dir
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            mkdir -p /var/www/anzhiyu-blog

      - name: Sync public (rsync)
        uses: easingthemes/ssh-deploy@v4.1.10
        with:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          REMOTE_HOST: ${{ secrets.SSH_HOST }}
          REMOTE_USER: ${{ secrets.SSH_USER }}
          REMOTE_PORT: ${{ secrets.SSH_PORT }}
          SOURCE: "anzhiyu-blog/public/"
          TARGET: "/var/www/anzhiyu-blog/"
          ARGS: "-avz --delete"
          # 可选：忽略某些文件
          # EXCLUDE: ".DS_Store"
      # 可选：如果你想热加载反代（一般纯静态不需要）
      # - name: Reload nginx proxy
      #   uses: appleboy/ssh-action@v1.0.3
      #   with:
      #     host: ${{ secrets.SSH_HOST }}
      #     username: ${{ secrets.SSH_USER }}
      #     key: ${{ secrets.SSH_PRIVATE_KEY }}
      #     port: ${{ secrets.SSH_PORT }}
      #     script: docker exec nginx-proxy nginx -s reload || true
